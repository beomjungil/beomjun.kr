---
import { i18n } from '@/i18n/utils';
import Segmented from './Segmented.astro';

const { t, language } = i18n(Astro.url);
const languageOptions = [
  {
    value: 'ko',
    label: '한국어',
    icon: () => `<div class="size-3 font-bold text-xs flex items-center justify-center">한</div>`,
  },
  {
    value: 'en',
    label: 'English',
    icon: () => `<div class="size-3 font-bold text-xs flex items-center justify-center">EN</div>`,
  },
  {
    value: 'ja',
    label: '日本語',
    icon: () => `<div class="size-3 font-bold text-xs flex items-center justify-center">日</div>`,
  },
];
---
<label class="flex flex-col gap-2 w-full md:w-fit">
  <span class="typo-caption uppercase !tracking-widest">{t('language')}</span>
  <Segmented
    options={languageOptions}
    iconOnly
    name="language"
    defaultValue={language}
  />
</label>

<script>
  import { getTranslatedPath } from '@/i18n/utils';
import { navigate } from 'astro:transitions/client';

  function setupLanguageChangeListener() {
    document.addEventListener('segment:language:change', (e) => {
      const { value } = (e as CustomEvent).detail;
      const tPath = getTranslatedPath(value);
      const currentPath = window.location.pathname;
      const pathWithoutLang = currentPath.replace(/^\/(ko|en|ja)/, '');
      const newHref = tPath(
        pathWithoutLang,
        value,
      );
      navigate(newHref);
    });
  }

  document.addEventListener('astro:page-load', () => {
    setupLanguageChangeListener();
  });
</script>
